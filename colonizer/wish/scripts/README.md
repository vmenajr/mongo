Follow the steps below to run the tests

# Provision the cluster

**On the laptop:**

```
git pull
cd wish
../aws-shell.sh

Modify the variables and commands in `start_env.sh` (and wish[x].tfvars) with proper values

bash start_env.sh
```

`start_env.sh` basically does the following things:

```
// List all the environments
terraform env list
terraform env select <env>

// Create an execution plan. `-- -var allow_nvme=1` is to use nvme device on the shards 
./tf.sh plan -i -c <number of config servers> -m <number of mongos> -s <number of shards> [-r <region>] -- -var allow_nvme=1

// Apply the plan. `-- -var allow_nvme=1` is to use nvme device on the shards
./tf.sh apply -i -c <number of config servers> -m <number of mongos> -s <number of shards> [-r <region>] -- -var allow_nvme=1

// Save the output to a json file
terraform output -json > servers.json

// Scp the servers.json and the automation scripts to the client machine. The client machine can be found in servers.json
scp servers.json scripts/* colonizer@CLIENT:/home/colonizer

// Connect to the client machine
ssh colonizer@CLIENT
```

**The following are run on the client machine**

Just modify `start_test.sh` and run it. It will do the following things:

```

// Get the servers list from servers.json and save the hostnames in test_wish.json.
python run_test.py -t test_wish.json -s servers.json -a get_hosts

// Clean up the current cluster
python run_test.py -t test_wish.json -a clean

// Create the sharded cluster. This example creates the cluster on WiredTiger and SCCC.
// Run `python run_test.py -h` to check all the options

// test_wish.json is the configuration file that includes:
// - cluster_name: the name of the cluster, will be part of the shard name, test result directory etc. Replace with a proper name for this test
// - The hostnames for the ycsb clients, the information for the sharded cluster. (Some information is generated by the above `python run_test.py -t test_wish.json -s servers.json -a get_hosts` command. Some other information is generated after this command.
// - mongodbUrl[x]: the url used for the tests. When we run the test, it will start with mongodbUrl1 to mongodbUrlx to run the tests in a loop
// - workloads: the workload we'd like to run for each mongodbUrl
// - threads: the number of threads per shard for each workload and each mongodbUrl.  The script will calculate the actual threads used for YCSB client by multiple the number of shards.
// - url_options: the options used in the connection string

python run_test.py -t test_wish.json -a setup_mongodb -n test -u dba -e wiredTiger -c SCCC

(Optional but recommended - install the Monitoring Agent and add the cluster to CM monitoring) - This is not included in `start_test.sh`

// Load the data to the cluster
// workload_wish is used to load the data. You may want to change recordcount/threadcount while loading the data
nohup stdbuf -o 0 python run_test.py -t test_wish3_2.json -a load -w workload_wish &

// Restart all the mongos with --noAutoSplit

python run_test.py -t test_wish.json -a restart_mongos_no_auto_split


// Run the load test based on the numbers specified in test_wish.json and workload_wish (used as a template). Note all the *proportion and threadcount are generated based on the workloads and threads in test_wish.json.
nohup stdbuf -o 0 python run_test.py -t test_wish.json -a run -w workload_wish &
```

# Save the test results to a safe place

# Clean up the sharded cluster after the test if needed

```
python run_test.py -t test_wish.json -a clean
```

# Terminate the servers

**On the laptop:**

```
!!!! Copy the test results if you want to look at them later!!!

// Destroy the whole deployment - including the servers and VPC etc.
./tf.sh destroy [-r <region>]
```

# Parse the ycsb and connection stats:
```
Update `workloads = ['100R_0U', '90R_10U', '80R_20U', '50R_50U', '0R_100U']` with the proper workloads in parse_stats.py
python parse_stats.py -d test_results/<dir>/stats/
Or run the command with --ip_index -2 to parse the stats from multiple clients
python parse_stats.py -d test_results/<dir>/all_ycsb_stats/ --ip_index -2

python parse_conn_stats.py -d test_results/<dir>
```
